---
# Preámbulo con paquetes y definiciones básicas
# Se incluyen los comandos mínimos de LaTeX
#title: Examen 3 \\ Jesús Urrutia
author:
  - Jesus Alberto Urrutia Camacho (urcajeal@gmail.com)
header-includes:
  - \usepackage{array}
  - \usepackage{booktabs}
  - \usepackage{amsmath}
  - \allowdisplaybreaks #% para permitir rompimiento de ecuaciones en p\'aginas distintas
    #% ver http://tex.stackexchange.com/questions/51682/is-it-possible-to-pagebreak-aligned-equations
    #% para m\'as detalles
  #- \numberwithin{equation}{section} # Para numerar ecuaciones por secciones cuando están numeradas
  - \usepackage{amssymb}
  - \usepackage{mathtools}
  - \usepackage{braket}
  - \usepackage[shortlabels]{enumitem}
  - \usepackage[spanish]{babel}
  - \decimalpoint
  - \usepackage{graphicx}
  - \usepackage{caption}
  - \renewcommand{\and}{\\}
  - \renewcommand{\arraystretch}{1.2}
  - \usepackage{booktabs}
  - \usepackage{float}
  - \usepackage[font=small,labelfont=bf]{caption}
  - \usepackage{fancyhdr}
  - \usepackage{dsfont}
  # Usa el comando \mathds{1}
  # Ver
  # https://tex.stackexchange.com/questions/26637/how-do-you-get-mathbb1-to-work-characteristic-function-of-a-set
  # para más información acerca de números con estilo mathbb
  - \newcommand{\mb}[1]{\mathbb{#1}}
  # para usar kableExtra se requieren los siguientes paquetes
  # ver
  # https://haozhu233.github.io/kableExtra/awesome_table_in_pdf.pdf
  # para más detalles
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \floatplacement{figure}{H}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{xcolor}
output: 
  pdf_document:
    #toc: true
    toc_depth: 2
    number_sections: true
    df_print: kable
    highlight: tango
---
         
        
\pagestyle{fancy}
\fancyhf{}

\rhead{\begin{picture}(0,0)
\put(-40,-20)
{\includegraphics[width=30mm]
{images/iimas}}
\end{picture}}

\renewcommand{\headrulewidth}{0pt}
\rfoot[\thepage]{\vspace{-0.5cm} \thepage}

        
```{r setup, include = FALSE}
        knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```
         
```{r include = FALSE, echo = FALSE}
        ##  LIBRERÍAS
        # Aquí vamos a incluir las librerías que necesitemos
        # En donde se pongan pedazos de código, únicamente se comentará
        # Es BUENA PRÁCTICA poner las librerías al principio, por ello las ponemos aquí
        # library(library_name)
        library(knitr)
        #install.packages("kableExtra")
        library(kableExtra)
        library(cluster)
        library(mclust) 
        library(factoextra)
        library(dendextend)
        library(purrr)
        library(ggplot2)
library(lavaan)
library(psych)
library(polycor)
library(semPlot)
library(semTools)
library(psy)
library(MASS)
library(xtable)
library(kutils)
library(stargazer)
library(corrplot)
library(RColorBrewer)
library(PerformanceAnalytics)
library(corpcor)
library(gdata)
library(rgl)
library(GPArotation) 
library(Matrix)
library(car)
library(bpca)
library(lattice)
library(qgraph)
library(pathdiagram)
library(corrplot)
library(readr)

```


        
        
        

\title{ {\sc Universidad Nacional Autónoma de México}\\
\vspace{1cm}{\sc Instituto de Investigaciones en Matemáticas Aplicadas y en Sistemas}\\
                        \vspace{1cm}{\sc Especialización en Estadística Aplicada} \\
                        \vspace{1.5cm} {Modelos de Ecuaciones Estructurales} \\
                        \vspace{1.5cm} {Adicción juvenil y padres alcohólicos}
                }

\date{\vspace{1.5cm}Ciudad de México\\
        \vspace{1cm} \today }

\maketitle


\thispagestyle{fancy}
\newpage







<!-- DESCRIPCIÓN DEL PROBLEMA EN FUNCIÓN DE LO QUE ECRIBIÓ EL PROFESOR. -->

A continuación se muestra una tabla con el *nombre de variables*, sus *siglas*, a manera de codificación, y las variables que representan.

```{r, include=FALSE}
APDF <- read_csv("bd/APDF.csv")
View(APDF)
bd <- APDF[,2:8]
bdCon <- bd[,c(2,4:7)]
```



Dado que se cuenta con la base de datos se procede a hacer estadística descriptiva. Todas las variables son numéricas, pero _coa_ y _gen_ son variables dicotómias, donde $P(X|x_{coa}=0: Padres no alcoholicos)$, y $P(X|x_{gen} = 0 : Mujer)$, respectivamente. 
Además, las variables, _Stress_ , _emotion_ , _negaff_ y _peer_ son variables continuas, que parecen ser tasas o índices, ya que tienen valores positivos y menores de 6. Cabe destacar que no se cuenta con un diccionario de datos.

```{r, echo=FALSE}
str(bd)
summary(bd)
plot(bd[,4:7])
```


A continuación se muestran dos correlogramas. Cabe señalar que no hay ninguna correlación significativa. El primer correlograma integra a las correlaciones biserial, tetracórica y de pearson. Mientras que el segundo sólamente usa la  última correlación. Se evidencia, que las correlaciones para variables dicotómicas aumentaron (es decir, se intensificó su color).



```{r, include=FALSE}
cor1 <- cor(bdCon)
            
coaCor <- c(biserial(bd$age, bd$coa),
            biserial(c(bd$stress), bd$coa),
            biserial(bd$emotion, bd$coa), 
            biserial(bd$negaff, bd$coa),
            biserial(bd$peer, bd$coa)
            )
coaCor

genCor <- c(biserial(bd$age, bd$gen),
            biserial(bd$stress, bd$gen),
            biserial(bd$emotion, bd$gen), 
            biserial(bd$negaff, bd$gen),
            biserial(bd$peer, bd$gen))
GenCoA <- tetrachoric(as.data.frame(bd$coa), as.data.frame(bd$gen))

corCuad <- matrix(data = c(c(1, -0.09456621, 0.014, 0.41430068, 0.14398422, 0.10279496, 0.20542024),
                c(-0.09456621, 1, 0.12159467, -0.01973430, -0.08074436, 0.15121667, 0.39572236 ),
                c(0.014, 0.12159467, 1, -0.01121133, -0.04854675, -0.12520711, -0.10289694),
                c(0.41430068, -0.01973430 , -0.01121133, 1, 0.3664796, 0.2807905, 0.2402493),
                c(0.14398422, -0.08074436, -0.04854675, 0.3664796, 1, 0.35387788, 0.13368237 ),
                c(0.10279496, 0.15121667, -0.12520711, 0.2807905, 0.35387788, 1, 0.3145978),
                c(0.20542024, 0.39572236, -0.10289694,0.2402493 , 0.13368237, 0.3145978, 1)
                ),7,7)


personc <- cor(bd)
#Si quieres, agregar una matriz o dataframa para que se pueda hacer el correlograma.
```

```{r, include = TRUE, echo = FALSE, fig.pos = 'H', fig.dim = c(8,5), fig.align = "center", message=FALSE}
par(mfrow = c(2,1))
#cor_base <- cor(corCuad, use="complete.obs")
cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat<- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}
# matrix of the p-value of the correlation
p.mat <- cor.mtest(corCuad)
corrplot(corCuad, type = "upper", order = "hclust", tl.col = "black", tl.srt = 45, sig.level = 0.10)

#####


cor_base <- cor(bd, use="complete.obs")
cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat<- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}
# matrix of the p-value of the correlation
p.mat <- cor.mtest(cor_base)
corrplot(cor_base, type = "upper", order = "hclust", tl.col = "black", tl.srt = 45,  sig.level = 0.10)
```

# Diagramar modelo

```{r, diagramarSEM}

CorMid <- '
1.0
-0.09456621 1.0
0.01400000  0.12159467   1.0
0.41430068 -0.01973430  -0.01121133 1.0
0.14398422 -0.08074436  -0.04854675   0.36647960 1.0
0.10279496  0.15121667  -0.12520711  0.28079050  0.35387788 1.0
0.20542024  0.39572236 -0.10289694  0.24024930  0.13368237  0.3145978  1.0
'

comp.cor1 <- getCov(CorMid, sds = NULL, names = c("coa", "age", "gen", "stress", "emotion", "negaff", "peer"))

#Modelo teórico


mod1 <- '
stress ~ a*coa + b*gen + c*age
emotion ~ e*coa + f*gen + g*age
negaff ~ x*stress + y*emotion
peer ~ z*negaff
emotion ~~ stress
coa ~~ gen
gen ~~ age
coa ~~ age
'

# ###Efectos indirectos
# ###Efectos totales



n <- length(bd$coa)
sem1 <- sem(mod1, data = bd, sample.cov = comp.cor1, sample.nobs = n, se="bootstrap")
sem2 <- sem(mod1, data = bd, sample.cov = personc, sample.nobs = n, se="bootstrap")

# 
# summary(modelo, fit.measures = TRUE,standardized=T)
# #resumen <- summary(modelo, fit.measures = TRUE,standardized=T)
# fitmeasures(modelo)



semPaths(sem1, "mod","par", col=rainbow(7), style="lisrel", layout = "tree2",curve=1.5,curvePivot = TRUE,rotation = 2, label.cex=1.2, residuals = T, nDigits = 4, nCharNodes = 0, sizeMan = 10, sizeMan2 = 5)
legend("topleft", legend=c("Modelo de trayectoria: Bulimia"),col="blue",cex=1.5)

```


# Escribirlo matricialmente




\begin{align*}
Y_{stres} = 0Y_{stres} + 0Y_{emo} + 0Y_{neg} + 0Y_{peer} + \gamma_{1,1}X_{coa} + \gamma_{1,2} X_{gen} +  \gamma_{1,3} X_{age} + \varsigma_{1} \\
Y_{emo} = 0 Y_{stres} + 0Y_{emo} + 0Y_{neg}  + 0Y_{peer} + \gamma_{2,1}X_{coa} + \gamma_{2,2}X_{gen} + \gamma_{2,3}X_{age} + \varsigma_{2}\\
Y_{neg} = \beta_{1,1} Y_{stres} + \beta_{1,2}Y_{emo} + 0Y_{neg}  + 0Y_{peer} + 0X_{coa} + 0X_{gen} + 0X_{age} + \varsigma_{3} \\
Y_{emo} = 0Y_{stres} + 0Y_{emo} + \beta_{2,1}Y_{neg}  + + 0Y_{peer} + 0X_{coa} + 0X_{gen} + 0X_{age} + \varsigma_{4}
\end{align*}



\begin{align*}
\begin{bmatrix}
Y_{stre}\\
Y_{emo}\\
Y_{neg}\\
Y_{peer}
\end{bmatrix}
=
\begin{bmatrix}
0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 \\
\beta_{1,1} & \beta_{1,2} & 0 & 0 \\
0 & 0 & \beta_{2,1} & 0
\end{bmatrix}
\begin{bmatrix}
Y_{stre}\\
Y_{emo}\\
Y_{neg}\\
Y_{peer}
\end{bmatrix}
+
\begin{bmatrix}
\gamma_{1,1} & \gamma_{1,2} & \gamma_{1,3} \\
\gamma_{2,1} & \gamma_{2,2} & \gamma_{2,3} \\
0 & 0 & 0 \\
0 & 0 & 0
\end{bmatrix}
\begin{bmatrix}
X_{coa}\\
X_{gen} \\
X_{age}
\end{bmatrix}
+
\begin{bmatrix}
\varsigma_{1}\\
\varsigma_{2}\\
\varsigma_{3}\\
\varsigma_{4}
\end{bmatrix}
\end{align*}


 

# Escribir matrices involucradas en modelo

Además, respéctivamente, cada matriz presentada con anterioridad puede se expresada como:
$Y = B Y + \Gamma x + \zeta$\\


\begin{align*}
		\mathbf{\Psi} =
	\begin{bmatrix}
		\psi_{1,1}	&   0           &  0    &   0 \\
		\psi_{2,1}    &   \psi_{2,2}  &  0   &  0\\
		0			&        	0			&  \psi_{3,1} & 0\\
		0 & 0 & 0 &   \psi_{4,1}\\
	\end{bmatrix}
	\;
	\mathbf{\Phi} =
	\begin{bmatrix}
		\phi_{1,1}    &   0              &  0   \\
		\phi_{2,1}    &   \phi_{2,2}     & 0 \\
		\phi_{3,1}    &   \phi_{3,2}     &   \phi_{3,3}    \\
	\end{bmatrix}
\end{align*}

Cabe destacar que $\Psi$ representa la matriz de correlación entre variables endógenas ($Y_{i}$). Mientras que la matriz de $\Phi$ presenta a la correlación entre variables exógenas ($X_{i}$).


# Ajuste del modelo

La estimación del modelo emplea el método bootstrap, como alternativa a las restricciones del supuesto de normalidad por el método delta. Lo anterior requiere que la muestra esté disponible para realizar el remuestreo (Hallquist, 2019). Además, se emplean la paquetería _lavaan_ como principal instrumento de ajuste computaciones. A continuación se muestra el código empleado.

```{r}

# CorMid 
# comp.cor1 <- getCov(CorMid, sds = NULL, names = c("coa", "age", "gen", "stress", "emotion", "negaff", "peer")
# mod1 
# sem1 <- sem(mod1, data = bd, sample.cov = comp.cor1, sample.nobs = n, se="bootstrap")


summary(sem1, fit.measures = TRUE,standardized=T)
#resumen <- summary(modelo, fit.measures = TRUE,standardized=T)
fitmeasures(sem1)

```
# Verifique lo adecuado del ajuste

# Interpretar efectos directos, indirectos, totales y concluir

